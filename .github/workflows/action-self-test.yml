name: Action Self Test

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  wrapper-python:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run wrapper (python fixture)
        id: sdkdrift
        uses: ./
        with:
          spec: ./fixtures/simple/openapi.yaml
          sdk: ./fixtures/simple/sdk/python
          lang: python
          format: json
          out: ./tests/action-self-test-python.report.json
          min-score: 10
          artifact-name: sdkdrift-self-test-python

      - name: Verify output file exists
        run: test -f "${{ steps.sdkdrift.outputs.report-path }}"

      - name: Publish SDKDrift summary
        run: |
          REPORT_PATH="${{ steps.sdkdrift.outputs.report-path }}"
          node -e '
            const fs = require("node:fs");
            const path = process.argv[1];
            const r = JSON.parse(fs.readFileSync(path, "utf8"));
            const summary = [
              "### SDKDrift Self-Test (python fixture)",
              "",
              `- Score: **${r.score}**`,
              `- Operations matched: **${r.summary.operationsMatched}/${r.summary.operationsTotal}**`,
              `- Findings: **${r.summary.findingsTotal}**`,
              `- Actionable: **${r.summary.actionableFindingsTotal ?? 0}**`,
              `- Coverage notes: **${r.summary.coverageNotesTotal ?? 0}**`
            ].join("\n");
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `${summary}\n\n`);
          ' "$REPORT_PATH"

  wrapper-ts:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run wrapper (ts fixture)
        id: sdkdrift
        uses: ./
        with:
          spec: ./fixtures/cases/ts-basic/openapi.yaml
          sdk: ./fixtures/cases/ts-basic/sdk/ts
          lang: ts
          format: json
          out: ./tests/action-self-test-ts.report.json
          min-score: 90
          artifact-name: sdkdrift-self-test-ts

      - name: Verify output file exists
        run: test -f "${{ steps.sdkdrift.outputs.report-path }}"

      - name: Publish SDKDrift summary
        run: |
          REPORT_PATH="${{ steps.sdkdrift.outputs.report-path }}"
          node -e '
            const fs = require("node:fs");
            const path = process.argv[1];
            const r = JSON.parse(fs.readFileSync(path, "utf8"));
            const summary = [
              "### SDKDrift Self-Test (ts fixture)",
              "",
              `- Score: **${r.score}**`,
              `- Operations matched: **${r.summary.operationsMatched}/${r.summary.operationsTotal}**`,
              `- Findings: **${r.summary.findingsTotal}**`,
              `- Actionable: **${r.summary.actionableFindingsTotal ?? 0}**`,
              `- Coverage notes: **${r.summary.coverageNotesTotal ?? 0}**`
            ].join("\n");
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `${summary}\n\n`);
          ' "$REPORT_PATH"
